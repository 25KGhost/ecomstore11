-- 1. Enable RLS
alter table auth.users enable row level security;

-- 2. Create Tables
create table public.categories (
  id bigint generated by default as identity primary key,
  name text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

create table public.products (
  id bigint generated by default as identity primary key,
  name text not null,
  slug text not null unique,
  description text,
  price numeric not null,
  image_url text,
  category_id bigint references public.categories(id) on delete set null,
  active boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

create table public.orders (
  id bigint generated by default as identity primary key,
  customer_name text not null,
  phone text not null,
  wilaya text not null,
  product_id bigint references public.products(id),
  quantity int default 1,
  status text default 'new', -- new, contacted, delivered
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Row Level Security (RLS) Policies

-- Categories: Public Read, Admin Write
alter table public.categories enable row level security;
create policy "Public categories are viewable" on public.categories for select using (true);
create policy "Admins can insert categories" on public.categories for insert with check (auth.role() = 'authenticated');
create policy "Admins can update categories" on public.categories for update using (auth.role() = 'authenticated');
create policy "Admins can delete categories" on public.categories for delete using (auth.role() = 'authenticated');

-- Products: Public Read (Active only), Admin All
alter table public.products enable row level security;
create policy "Public products are viewable" on public.products for select using (active = true or auth.role() = 'authenticated');
create policy "Admins can insert products" on public.products for insert with check (auth.role() = 'authenticated');
create policy "Admins can update products" on public.products for update using (auth.role() = 'authenticated');
create policy "Admins can delete products" on public.products for delete using (auth.role() = 'authenticated');

-- Orders: Public Insert, Admin Read/Update
alter table public.orders enable row level security;
create policy "Public can create orders" on public.orders for insert with check (true);
create policy "Admins can view orders" on public.orders for select using (auth.role() = 'authenticated');
create policy "Admins can update orders" on public.orders for update using (auth.role() = 'authenticated');